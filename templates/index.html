<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Inundações</title>

    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { font-family: 'Inter', sans-serif; }
        body { margin: 0; padding: 0; overflow: hidden; }

        .card {
            @apply bg-white rounded-lg shadow-sm border border-gray-200;
        }

        .btn-primary {
            @apply bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors font-medium;
        }

        .input-field {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
        }

        .stat-card {
            @apply bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200;
        }

        #map {
            height: 100%;
            border-radius: 8px;
        }

        .scrollable {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        .scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border: 1px solid #6b7280;
            border-radius: 3px;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [level, setLevel] = useState('province');
            const [province, setProvince] = useState('all');
            const [municipality, setMunicipality] = useState('all');
            const [district, setDistrict] = useState('all');
            const [floodRate, setFloodRate] = useState(50);
            const [waterLevel, setWaterLevel] = useState(50);
            const [provinces, setProvinces] = useState([]);
            const [municipalities, setMunicipalities] = useState([]);
            const [districts, setDistricts] = useState([]);
            const [results, setResults] = useState(null);
            const [loading, setLoading] = useState(false);
            const [stats, setStats] = useState(null);
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);

            useEffect(() => {
                loadProvinces();
                lucide.createIcons();
            }, []);

            useEffect(() => {
                if (province !== 'all') {
                    loadMunicipalities(province);
                } else {
                    setMunicipalities([]);
                    setMunicipality('all');
                }
            }, [province]);

            useEffect(() => {
                if (municipality !== 'all' && level === 'district') {
                    loadDistricts(municipality);
                } else {
                    setDistricts([]);
                    setDistrict('all');
                }
            }, [municipality, level]);

            useEffect(() => {
                lucide.createIcons();
            }, [results, stats]);

            const loadProvinces = async () => {
                try {
                    const res = await fetch('/api/provinces');
                    const data = await res.json();
                    if (data.success) setProvinces(data.data);
                } catch (err) {
                    console.error('Erro ao carregar províncias:', err);
                }
            };

            const loadMunicipalities = async (prov) => {
                try {
                    const res = await fetch(`/api/municipalities?province=${encodeURIComponent(prov)}`);
                    const data = await res.json();
                    if (data.success) setMunicipalities(data.data);
                } catch (err) {
                    console.error('Erro ao carregar municípios:', err);
                }
            };

            const loadDistricts = async (mun) => {
                try {
                    const correctedMun = mun.replace('-', ' ');
                    const res = await fetch(`/api/districts?municipality=${encodeURIComponent(correctedMun)}`);
                    const data = await res.json();
                    if (data.success) setDistricts(data.data);
                } catch (err) {
                    console.error('Erro ao carregar distritos:', err);
                }
            };

            const runSimulation = async () => {
                setLoading(true);
                try {
                    const payload = {
                        level,
                        province,
                        municipality: level === 'municipality' || level === 'district' ? municipality : 'all',
                        district: level === 'district' ? district : 'all',
                        floodRate: parseFloat(floodRate),
                        waterLevel: parseFloat(waterLevel)
                    };

                    const res = await fetch('/api/simulate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();

                    if (data.success) {
                        setResults(data.data);
                        setStats(data.statistics);
                        if (data.geojson) {
                            renderMap(data.geojson);
                        }
                    } else {
                        console.error('Erro na simulação:', data.error);
                    }
                } catch (err) {
                    console.error('Erro na simulação:', err);
                } finally {
                    setLoading(false);
                }
            };

            const renderMap = (geojsonData) => {
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.remove();
                }

                const map = L.map(mapRef.current).setView([-12.5, 18.5], 5);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, CartoDB',
                    maxZoom: 18,
                }).addTo(map);

                const getColorByWaterLevel = (level) => {
                    if (level === 0) return '#e5e7eb'; // Tailwind's gray-200
                    const maxLevel = 5;
                    const intensity = Math.min(level / maxLevel, 1);

                    const r_start = 121, g_start = 166, b_start = 210; // Cor do map-flood-low (aproximada)
                    const r_end = 0, g_end = 51, b_end = 102;        // Cor do map-flood-high (aproximada)

                    const r = Math.round(r_start + (r_end - r_start) * intensity);
                    const g = Math.round(g_start + (g_end - g_start) * intensity);
                    const b = Math.round(b_start + (b_end - b_start) * intensity);

                    return `rgb(${r}, ${g}, ${b})`;
                };

                const geoJson = JSON.parse(geojsonData);
                const geoJsonLayer = L.geoJSON(geoJson, {
                    style: (feature) => ({
                        fillColor: feature.properties.flooded ? getColorByWaterLevel(feature.properties.waterLevel) : '#e5e7eb', // gray-200
                        fillOpacity: feature.properties.flooded ? 0.8 : 0.6,
                        color: '#6b7280', // Tailwind's gray-700 for border
                        weight: 1,
                    }),
                    pointToLayer: (feature, latlng) => {
                        const color = feature.properties.flooded ? getColorByWaterLevel(feature.properties.waterLevel) : '#e5e7eb';
                        return L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: color,
                            color: '#6b7280',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        const popupContent = `
                            <div class="p-2 font-inter">
                                <h4 class="font-bold text-blue-700">${props.name}</h4>
                                ${props.municipality ? `<p class="text-sm text-gray-700"><strong>Município:</strong> ${props.municipality}</p>` : ''}
                                <p class="text-sm text-gray-700"><strong>Inundada:</strong> ${props.flooded ? '<span class="text-red-600 font-medium">Sim</span>' : '<span class="text-green-600 font-medium">Não</span>'}</p>
                                <p class="text-sm text-gray-700"><strong>Nível de Água:</strong> ${props.waterLevel.toFixed(2)} m</p>
                                <p class="text-sm text-gray-700"><strong>População Afetada:</strong> ${props.affectedPopulation.toLocaleString('pt-BR')}</p>
                            </div>
                        `;
                        layer.bindPopup(popupContent);

                        layer.on({
                            mouseover: (e) => {
                                if (e.target.setStyle) {
                                    e.target.setStyle({ weight: 3, radius: 10 });
                                }
                            },
                            mouseout: (e) => {
                                geoJsonLayer.resetStyle(e.target);
                            }
                        });
                    }
                }).addTo(map);

                try {
                    const bounds = geoJsonLayer.getBounds();
                    if (bounds && bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [20, 20] });
                    } else {
                        map.setView([-12.5, 18.5], 6);
                    }
                } catch (error) {
                    console.warn('Não foi possível ajustar os limites do mapa:', error);
                    map.setView([-12.5, 18.5], 6);
                }

                mapInstanceRef.current = map;

                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'legend bg-white p-3 rounded-lg shadow-md border border-gray-200 text-sm');
                    div.innerHTML += '<h4 class="font-semibold mb-2 text-gray-800">Legenda do Risco</h4>';
                    div.innerHTML += '<div class="flex items-center mb-1"><span class="legend-color mr-2" style="background: #e5e7eb;"></span> Não Inundada</div>';
                    div.innerHTML += '<div class="flex items-center mb-1"><span class="legend-color mr-2" style="background: #79a6d2;"></span> Baixa Severidade</div>'; // Cor do map-flood-low
                    div.innerHTML += '<div class="flex items-center"><span class="legend-color mr-2" style="background: #003366;"></span> Alta Severidade</div>'; // Cor do map-flood-high
                    return div;
                };
                legend.addTo(map);
            };

            const formatNumber = (num) => {
                return num.toLocaleString('pt-BR');
            };

            return (
                <div className="h-screen flex flex-col">
                    <header className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 shadow-lg flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <i data-lucide="droplets" className="w-8 h-8"></i>
                            <h1 className="text-2xl font-bold">Simulador de Impacto de Inundações</h1>
                        </div>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        <div className="w-80 bg-white border-r border-gray-200 flex flex-col">
                            <div className="p-6 border-b border-gray-200">
                                <h2 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="settings" className="w-5 h-5"></i>
                                    Configurações
                                </h2>
                            </div>

                            <div className="flex-1 overflow-y-auto scrollable p-6 space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Nível de Análise</label>
                                    <select value={level} onChange={(e) => setLevel(e.target.value)} className="input-field">
                                        <option value="province">Província</option>
                                        <option value="municipality">Município</option>
                                        <option value="district">Distrito</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Província</label>
                                    <select value={province} onChange={(e) => setProvince(e.target.value)} className="input-field">
                                        <option value="all">Todas</option>
                                        {provinces.map(p => <option key={p.id || p.name} value={p.name}>{p.name}</option>)}
                                    </select>
                                </div>

                                {(level === 'municipality' || level === 'district') && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Município</label>
                                        <select value={municipality} onChange={(e) => setMunicipality(e.target.value)} className="input-field">
                                            <option value="all">Todos</option>
                                            {municipalities.map(m => <option key={m.id || m.name} value={m.name}>{m.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                {level === 'district' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Distrito</label>
                                        <select value={district} onChange={(e) => setDistrict(e.target.value)} className="input-field">
                                            <option value="all">Todos</option>
                                            {districts.map(d => <option key={d.id || d.name} value={d.name}>{d.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Taxa de Inundação: {floodRate}%
                                    </label>
                                    <input type="range" min="0" max="100" value={floodRate} onChange={(e) => setFloodRate(e.target.value)} className="w-full" />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Nível de Água: {waterLevel}m
                                    </label>
                                    <input type="range" min="0" max="100" step="0.1" value={waterLevel} onChange={(e) => setWaterLevel(e.target.value)} className="w-full" />
                                </div>

                                <button onClick={runSimulation} disabled={loading} className="btn-primary w-full flex items-center justify-center gap-2">
                                    {loading ? (
                                        <>
                                            <i data-lucide="loader-2" className="w-4 h-4 animate-spin"></i>
                                            Processando...
                                        </>
                                    ) : (
                                        <>
                                            <i data-lucide="play" className="w-4 h-4"></i>
                                            Executar Simulação
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col overflow-hidden">
                            {stats && (
                                <div className="p-6 border-b border-gray-200 bg-white">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="stat-card">
                                            <p className="text-sm text-gray-600">Áreas Inundadas</p>
                                            <p className="text-2xl font-bold text-blue-600">{stats.floodedCount}</p>
                                        </div>
                                        <div className="stat-card">
                                            <p className="text-sm text-gray-600">População Afetada</p>
                                            <p className="text-2xl font-bold text-blue-600">{formatNumber(stats.totalAffected)}</p>
                                        </div>
                                        <div className="stat-card">
                                            <p className="text-sm text-gray-600">Total de Áreas</p>
                                            <p className="text-2xl font-bold text-blue-600">{stats.totalItems}</p>
                                        </div>
                                        <div className="stat-card">
                                            <p className="text-sm text-gray-600">Risco Médio</p>
                                            <p className="text-2xl font-bold text-blue-600">{stats.avgRisk.toFixed(1)}%</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="flex-1 p-6 flex flex-col lg:flex-row gap-6 overflow-y-auto scrollable">
                                <div className="lg:w-2/3 h-96 lg:h-auto card p-4">
                                    <div ref={mapRef} className="w-full h-full"></div>
                                </div>

                                <div className="lg:w-1/3 flex flex-col gap-4">
                                    <div className="card p-4 flex-1 scrollable">
                                        <h3 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                            <i data-lucide="list-checks" className="w-5 h-5"></i>
                                            Resultados Detalhados
                                        </h3>
                                        {results && results.length > 0 ? (
                                            <div className="space-y-3">
                                                {results.map((item, index) => (
                                                    <div key={index} className={`p-3 rounded-lg border ${item.flooded ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                                                        <p className="font-medium text-sm flex items-center gap-1">
                                                            {item.flooded ? <i data-lucide="alert-triangle" className="w-4 h-4 text-red-600"></i> : <i data-lucide="check-circle" className="w-4 h-4 text-green-600"></i>}
                                                            {item.name}
                                                        </p>
                                                        <p className={`text-xs font-medium ${item.flooded ? 'text-red-600' : 'text-green-600'}`}>
                                                            Status: {item.flooded ? 'Inundada' : 'Segura'}
                                                        </p>
                                                        <p className="text-xs text-gray-700">Nível: {item.waterLevel.toFixed(2)} m</p>
                                                        <p className="text-xs text-gray-700">População Afetada: {formatNumber(item.affectedPopulation)}</p>
                                                        <p className="text-xs text-gray-700">Recuperação: {item.recoveryDays} dias</p>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-center text-gray-500 italic py-8">
                                                <i data-lucide="info" className="w-4 h-4 inline-block mr-1"></i>
                                                Configure e execute uma simulação para ver os resultados detalhados.
                                            </p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>